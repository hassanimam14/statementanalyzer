{
  auto_https off
  admin off
}

:{$PORT} {
  encode zstd gzip
  root * /app/public

  # Block sensitive paths & dotfiles
  @private path_regexp private ^/(?:\.|vendor/|storage/|bootstrap/|database/|resources/|config/|tests/|node_modules/).*
  respond @private 404
  @dotfiles path */.*
  respond @dotfiles 404

  # Security headers
  header {
    Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
    X-Content-Type-Options "nosniff"
    X-Frame-Options "SAMEORIGIN"
    Referrer-Policy "strict-origin-when-cross-origin"
    Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=()"
    -Server
  }

  # Limit upload size (tune as needed)
  request_body {
    max_size 15MB
  }

  # Serve common static assets directly
  @static {
    path /assets/* /build/* /favicon.ico /robots.txt
  }
  handle @static {
    file_server
  }

  # PHP handler (includes fallback to index.php for Laravel)
  php_fastcgi 127.0.0.1:9000
  # If you use a Unix socket instead:
  # php_fastcgi unix//run/php/php-fpm.sock

  # Final static file server
  file_server
}
